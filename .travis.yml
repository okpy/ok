sudo: required
dist: trusty
language: python
cache: pip
services:
  - docker
  - redis
python:
    - "3.5"
env:
  global:
     - OK_ENV=test
  matrix:
    - USE_DOCKER=1
    - USE_NATIVE=1
  # Google Cloud Storage Integration Test Env Vars
  - secure: "fLVIPcjFTBZ69AmicHMMP1t3oCLpROZo/+cnPXl3vHJCqUYGSxT51t9ZfpjijfjmKWJfF+WJw5C6N/qU2bne30wWTX+69a0MvF6PyLhnePMH/1NTSpR89fG6+mXaQyX4bPinR0PLAOoWFIjF6NQ9w7SgTlz8Z+bHgobV68jmqnE="
  - secure: "FDaXghfVy0m/g/SoHA3MAPWXwXQWN2UwBxOUaY0TYawMreLv46QgVQhauwaCaBSyHkd8PlfshIvPhXHl+i8F1Yn4Wk0PXP/bfYw4jWyWmJ+5aivY0apUvIAa/Q6LEjyekWKH64p2FWCSAEtV6pJq4fKdgjRiPbcS2Y1nn74qffA=" 
  - secure: "moGAgNpj7wrPcaAStJZ7xQfxJsu99kEiPfGmhML/FlYm/muGp0PTrykyG5EjnzIwrdfVTL+uQhmUql0tR2T9g9I+FH2xG/cBelgsXJMAA22/FBAHUfQDRi23TT3eLhqsH+wC3c4K7CJFxXm0kB2iSkziHrgPjLm2S25TLIAklP8="
install:
  - if [ -n "$USE_DOCKER" ]; then travis_retry make docker-build; fi
  - if [ -n "$USE_NATIVE" ]; then travis_retry pip --timeout=60 install -r requirements.txt; fi
  - if [ -n "$USE_NATIVE" ]; then travis_retry pip --timeout=60 install pytest-timeout python-coveralls; fi
script:
  - if [ -n "$USE_DOCKER" ]; then make docker-test; fi
  - if [ -n "$USE_NATIVE" ]; then py.test --cov-report term-missing --cov=server tests/  --ignore tests/test_web.py --timeout=30; fi
after_success:
  - if [ -n "$USE_NATIVE" ]; then echo "eventually should run coveralls here"; fi
notifications:
  email: false
  slack:
    on_success: never
    on_failure: always
    secure: mGqCgRCFMB89AKsYVOZI79sifCFOLaQkuY3rvFKMitpD1GYQQpkBbZ9Z1SWi0VQV63oOKTQBrPCeDSwhZMaJA/dCZZIuz6e9nkVyJJUIrqAuH9PjgQr6FM4FkKzVLpHdPnXIikAvUAKiPRzzj8z4KO1EohBRR/xb2/4TpoWrkSA=
